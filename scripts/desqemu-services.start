#!/bin/sh

# Initialize and start podman machine as desqemu user
# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º –∏ –∑–∞–ø—É—Å–∫–∞–µ–º podman machine –æ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è desqemu
su desqemu -c 'podman machine init --cpus 2 --memory 2048 --disk-size 20 || true'
su desqemu -c 'podman machine start || true'

# Start simple web server for DESQEMU interface
# –ó–∞–ø—É—Å–∫–∞–µ–º –ø—Ä–æ—Å—Ç–æ–π –≤–µ–±-—Å–µ—Ä–≤–µ—Ä –¥–ª—è –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ DESQEMU
su desqemu -c 'cd /home/desqemu && python3 -m http.server 8080 > /tmp/desqemu-web.log 2>&1 &'

# Set up VNC password for remote desktop access
# –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ–º –ø–∞—Ä–æ–ª—å VNC –¥–ª—è —É–¥–∞–ª–µ–Ω–Ω–æ–≥–æ –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–∞–±–æ—á–µ–º—É —Å—Ç–æ–ª—É
su desqemu -c 'mkdir -p /home/desqemu/.vnc && echo "desqemu" | vncpasswd -f > /home/desqemu/.vnc/passwd && chmod 600 /home/desqemu/.vnc/passwd'

# Auto-start compose if docker-compose.yml exists
# –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫ compose –µ—Å–ª–∏ –µ—Å—Ç—å docker-compose.yml
if [ -f "/home/desqemu/docker-compose.yml" ]; then
    echo "üöÄ –û–±–Ω–∞—Ä—É–∂–µ–Ω docker-compose.yml, –∑–∞–ø—É—Å–∫–∞–µ–º –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏..."
    su desqemu -c '/home/desqemu/auto-start-compose.sh > /tmp/desqemu-compose.log 2>&1 &'
fi

echo "‚úÖ DESQEMU —Å–µ—Ä–≤–∏—Å—ã –∑–∞–ø—É—â–µ–Ω—ã" 
